<?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="notice">

	<select id="selectList" resultType="NoticeVO" parameterType="Long">
		SELECT 'board_like' AS type, b.boardLikeTime AS notice_time, m.memberNo, mp.attachmentNo
		FROM board b
		INNER JOIN memberProfile mp ON mp.attachmentNo = b.memberNo
		INNER JOIN member m ON m.memberNo = mp.memberNo
		WHERE b.memberNo = #{memberNo}
		
		UNION
		
		SELECT 'reply' AS type, r.replyTime AS notice_time, m.memberNo, mp.attachmentNo
		FROM reply r
		INNER JOIN memberProfile mp ON mp.attachmentNo = r.memberNo
		INNER JOIN member m ON m.memberNo = mp.memberNo
		WHERE r.memberNo = #{memberNo}
		
		UNION
		
		SELECT 'reply_like' AS type, rl.replyLikeTime AS notice_time, m.memberNo, mp.attachmentNo
		FROM replyLike rl
		INNER JOIN reply r ON r.replyNo = rl.replyNo
		INNER JOIN memberProfile mp ON mp.attachmentNo = r.memberNo
		INNER JOIN member m ON m.memberNo = mp.memberNo
		WHERE r.memberNo = #{memberNo}
		
		UNION
		
		SELECT 'follow' AS type, f.followTime AS notice_time, m.memberNo, mp.attachmentNo
		FROM follow f
		INNER JOIN memberProfile mp ON mp.attachmentNo = f.followFollower
		INNER JOIN member m ON m.memberNo = mp.memberNo
		WHERE f.followFollower = #{memberNo}
	</select>

	
	<update id="checkBL" parameterType="int">
		update board_like set board_like_check = 1 where board_no in (
		    select b.board_no from board  b
		        inner join board_like bl on b.board_no = bl.board_no
		    where b.member_no = #{memberNo}
	    ) and board_like_check = 0
	</update>

	<update id="checkFollow" parameterType="int">
		update follow set follow_check = 1 where follow_follower = #{memberNo} and follow_check = 0
	</update>
	
	<update id="checkBR" parameterType="int">
		update reply set reply_check = 1 where reply_no in (
			select r.reply_no from board b 
			    inner join board_reply br on b.board_no = br.board_no
			    inner join reply r on r.reply_no = br.reply_no
			where b.member_no = #{memberNo}
		) and reply_check = 0
	</update>
	
	<update id="checkBR2" parameterType="int">
		update reply_like set reply_like_check = 1 where reply_no in (
		    select r.reply_no from reply r
<!-- 		    댓글좋아요 rl 별칭없음 -->
		        inner join reply_like rl on r.reply_no = rl.reply_no		
		    where b.member_no = #{memberNo}
	    ) and reply_like_check = 0
	</update>
	
	<select id="isNotice" resultType="int" parameterType="int">
		select * from (
			select board_no "no" from board_like where board_no in (
			        select b.board_no from board  b
			        inner join board_like bl on b.board_no = bl.board_no
			    where b.member_no = #{memberNo}) and board_like_check = 0
			    
			union

			select member_no "no" from follow where follow_follower = #{memberNo} and follow_check = 0
			        
			union
			
			select reply_no"no" from reply where reply_no in (
			        select r.reply_no from board b 
			            inner join board_reply br on b.board_no = br.board_no
			            inner join reply r on r.reply_no = br.reply_no
			        where b.member_no = #{memberNo}
	        ) and reply_check = 0
        ) where rownum = 1
	</select>
	
 </mapper> 